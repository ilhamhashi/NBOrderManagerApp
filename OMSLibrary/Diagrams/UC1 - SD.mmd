sequenceDiagram 

actor User 
participant NewOrderView 
participant NewOrderViewModel 
participant OrderService 
participant OrderRepository 
participant OrderLineService
participant PaymentService
participant NoteRepository
participant PickUpRepository 
participant DataBase

User->>NewOrderView: Enter new order information 
NewOrderView->>OrderViewModel: CreateOrderCommand.Execute() 
OrderViewModel->>OrderService: CreateOrder(order, orderLines, payments) 
OrderService->>PickUpRepository: Insert(order.PickUp) 
PickUpRepository->> Database: EXEC spPickUp_Insert(Date, IsDelivery, Location) 
Database ->> PickUpRepository: return Id 
PickUpRepository->> OrderService: return Id 
OrderService->>NoteRepository: Insert(order.Note) 
NoteRepository->> Database: EXEC spNote_Insert(Content) 
Database ->> NoteRepository: return Id 
NoteRepository->> OrderService: return Id 
OrderService->>OrderRepository: Insert(order) 
OrderRepository->>Database: EXEC spOrder_Insert(Date, Status, CustomerId, PickUpId, NoteId) 
Database-->>OrderRepository: return Id 
OrderRepository->>OrderService: return Id 
loop For each OrderLine 
	OrderService ->> OrderLineService: CreateOrderLine(line)
	OrderLineServiceRepository: Insert(orderLine) 
	OrderLineRepository ->> Database: EXEC spOrderLine_Insert(OrderId, ProductId, LineNumber, ...) 
	Database ->> OrderLineRepository: Confirmation 
	OrderLineRepository ->> OrderService: Confirmation 
end 
loop For each Payment 
	OrderService ->> PaymentRepository: Insert(payment) 
	PaymentRepository ->> Database: EXEC spPayment_Insert(PaymentAmount, PaymentDate, OrderId, PaymentMethodId) 
	Database ->> PaymentRepository: Confirmation 
	PaymentRepository ->> OrderService: Confirmation 
end 
alt isDelivery 
	OrderService ->> DeliveryRepository: Insert(delivery) 
	DeliveryRepository->> Database: EXEC spDelivery_Insert(CollectionDate, Neighborhood, OrderId) 
	Database ->> DeliveryRepository: Confirmation 
	DeliveryRepository->> OrderService: Confirmation 
else isPickUp 
	OrderService ->> PickUpRepository: Insert(pickup) 
	PickUpRepository->> Database: EXEC spPickUp_Insert(CollectionDate, OrderId) 

end 
OrderService ->> Database: COMMIT (transaction) 
Database ->> OrderService: Confirmation 
OrderService ->> OrderViewModel: return result 
OrderViewModel ->> NewOrderView: Update UI with result 
NewOrderView->>User: Show success/failure message 




